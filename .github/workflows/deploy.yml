name: Full-Stack Deploy

on:
  push:
    branches: [ main ]

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Setup Node.js
      uses: actions/setup-node@v3
      with:
        node-version: '18'  # ĞœĞ¾Ğ¶Ğ½Ğ¾ Ğ¾ÑÑ‚Ğ°Ğ²Ğ¸Ñ‚ÑŒ 18, Ğ½Ğ¾ 20 Ğ»ÑƒÑ‡ÑˆĞµ

    - name: Install and build frontend
      working-directory: ./frontend
      run: |
        npm ci --legacy-peer-deps
        npm run build
        echo "âœ… Frontend built"

    - name: Deploy to server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "ğŸš€ SAFE DEPLOYMENT STARTING..."
          echo "âš ï¸  Media files in /media/ will NOT be touched!"
          
          # ========== 1. Ğ‘Ğ•Ğ—ĞĞŸĞĞ¡ĞĞ«Ğ™ GIT PULL ==========
          cd /home/django/may-walk-map
          
          # Ğ¡Ğ¾Ñ…Ñ€Ğ°Ğ½ÑĞµĞ¼ Ñ‚ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ¼ĞµĞ´Ğ¸Ğ°Ñ„Ğ°Ğ¹Ğ»Ñ‹ ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾
          echo "Backing up media if needed..."
          sudo cp -r media/ /tmp/media-backup/ 2>/dev/null || true
          
          # Git pull Ğ‘Ğ•Ğ— Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿Ğ¸ÑĞ¸ Ğ¼ĞµĞ´Ğ¸Ğ°
          git fetch origin
          git checkout -- .  # ĞÑ‚Ğ¼ĞµĞ½ÑĞµĞ¼ Ğ»Ğ¾ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ğµ Ğ¸Ğ·Ğ¼ĞµĞ½ĞµĞ½Ğ¸Ñ Ğ² Ğ¾Ñ‚ÑĞ»ĞµĞ¶Ğ¸Ğ²Ğ°ĞµĞ¼Ñ‹Ñ… Ñ„Ğ°Ğ¹Ğ»Ğ°Ñ…
          git pull origin main
          
          # ========== 2. Ğ‘Ğ­ĞšĞ•ĞĞ” ==========
          echo "ğŸ”§ Updating backend..."
          source venv/bin/activate
          pip install -r requirements.txt
          
          # ĞœĞ˜Ğ“Ğ ĞĞ¦Ğ˜Ğ˜ - Ğ±ĞµĞ·Ğ¾Ğ¿Ğ°ÑĞ½Ñ‹ Ğ´Ğ»Ñ Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…
          python manage.py migrate --noinput
          echo "âœ… Database migrations applied"
          
          # COLLECTSTATIC - Ğ½Ğµ Ñ‚Ñ€Ğ¾Ğ³Ğ°ĞµÑ‚ media/
          python manage.py collectstatic --noinput --clear
          echo "âœ… Static files collected"
          
          # ========== 3. Ğ’ĞĞ¡Ğ¡Ğ¢ĞĞĞĞ’Ğ›Ğ˜Ğ’ĞĞ•Ğœ ĞœĞ•Ğ”Ğ˜Ğ ==========
          echo "ğŸ–¼ï¸  Restoring media files..."
          # Ğ•ÑĞ»Ğ¸ Ğ¿Ğ°Ğ¿ĞºĞ° media Ğ±Ñ‹Ğ»Ğ° ÑĞ»ÑƒÑ‡Ğ°Ğ¹Ğ½Ğ¾ ÑƒĞ´Ğ°Ğ»ĞµĞ½Ğ° Git'Ğ¾Ğ¼
          if [ ! -d "media" ]; then
            echo "Media folder missing, restoring..."
            mkdir -p media
          fi
          
          # ĞšĞ¾Ğ¿Ğ¸Ñ€ÑƒĞµĞ¼ Ğ¾Ğ±Ñ€Ğ°Ñ‚Ğ½Ğ¾ Ğ¸Ğ· backup ĞµÑĞ»Ğ¸ Ğ½ÑƒĞ¶Ğ½Ğ¾
          if [ -d "/tmp/media-backup" ]; then
            sudo cp -r /tmp/media-backup/* media/ 2>/dev/null || true
            sudo rm -rf /tmp/media-backup
          fi
          
          # ========== 4. Ğ¤Ğ ĞĞĞ¢Ğ•ĞĞ” ==========
          echo "ğŸ¨ Deploying frontend..."
          sudo rm -rf /var/www/may-walk/html/*
          sudo cp -r frontend/dist/* /var/www/may-walk/html/
          sudo chown -R www-data:www-data /var/www/may-walk/html
          sudo chmod -R 755 /var/www/may-walk/html
          
          # ========== 5. Ğ¡Ğ•Ğ Ğ’Ğ˜Ğ¡Ğ« ==========
          echo "ğŸ”„ Restarting services..."
          sudo systemctl restart gunicorn
          sudo systemctl reload nginx
          
          # ========== 6. ĞŸĞ ĞĞ’Ğ•Ğ ĞšĞ ==========
          echo "âœ… DEPLOYMENT COMPLETE!"
          echo "ğŸ“Š Media folder status:"
          ls -la media/ 2>/dev/null | head -5 || echo "Media folder exists"
          echo ""
          echo "ğŸŒ Site: http://80.87.102.247/"
          echo "ğŸ“± API: http://80.87.102.247/map/api/routes/"
          echo "âš™ï¸  Admin: http://80.87.102.247/admin/"
          echo ""
          echo "âš ï¸  IMPORTANT: User-uploaded images in /media/ are SAFE"
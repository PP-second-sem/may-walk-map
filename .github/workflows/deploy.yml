name: Full-Stack Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to production server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          echo "ğŸš€ Starting full-stack deployment..."
          
          # 1. ĞĞ‘ĞĞĞ’Ğ›Ğ•ĞĞ˜Ğ• ĞšĞĞ”Ğ
          cd /home/django/may-walk-map
          git config --global --add safe.directory /home/django/may-walk-map
          git pull origin main
          
          # 2. Ğ‘Ğ­ĞšĞ•ĞĞ”
          echo "ğŸ”§ Setting up backend..."
          source venv/bin/activate
          pip install -r requirements.txt
          python manage.py migrate
          python manage.py collectstatic --noinput
          sudo systemctl restart gunicorn
          
          # 3. Ğ¤Ğ ĞĞĞ¢Ğ•ĞĞ”
          echo "ğŸ¨ Building frontend..."
          cd frontend
          
          # ĞŸÑ€Ğ¾Ğ²ĞµÑ€ÑĞµĞ¼ ĞµÑÑ‚ÑŒ Ğ»Ğ¸ node_modules
          if [ ! -d "node_modules" ]; then
            echo "ğŸ“¦ Installing Node.js dependencies..."
            npm ci --only=production
          else
            echo "ğŸ“¦ Updating Node.js dependencies..."
            npm install
          fi
          
          # Ğ¡Ğ±Ğ¾Ñ€ĞºĞ° Ñ„Ñ€Ğ¾Ğ½Ñ‚ĞµĞ½Ğ´Ğ°
          echo "ğŸ—ï¸ Building React app..."
          npm run build
          
          # 4. NGINX
          echo "ğŸŒ Restarting web server..."
          sudo systemctl restart nginx
          
          echo "âœ… Deployment completed successfully!"
          echo "ğŸŒ Site: http://80.87.102.247/"
          echo "ğŸ“Š API: http://80.87.102.247/map/api/routes/"
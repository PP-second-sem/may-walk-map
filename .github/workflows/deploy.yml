name: Full-Stack Deploy

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    - name: Deploy to production server
      uses: appleboy/ssh-action@master
      with:
        host: ${{ secrets.SERVER_HOST }}
        username: ${{ secrets.SERVER_USERNAME }}
        key: ${{ secrets.SSH_PRIVATE_KEY }}
        script: |
          set -e  # –í—ã–π—Ç–∏ –ø—Ä–∏ –ø–µ—Ä–≤–æ–π –æ—à–∏–±–∫–µ
          echo "üöÄ Starting full-stack deployment..."
          
          # ========== 1. –û–ë–ù–û–í–õ–ï–ù–ò–ï –ö–û–î–ê ==========
          cd /home/django/may-walk-map
          git config --global --add safe.directory /home/django/may-walk-map
          git pull origin main
          echo "‚úÖ Code updated"
          
          # ========== 2. –ë–≠–ö–ï–ù–î ==========
          echo "üîß Setting up backend..."
          source venv/bin/activate
          pip install -r requirements.txt 2>/dev/null || pip install django djangorestframework gpxpy gunicorn pillow
          python manage.py migrate --noinput
          python manage.py collectstatic --noinput
          sudo systemctl restart gunicorn
          echo "‚úÖ Backend updated"
          
          # ========== 3. –§–†–û–ù–¢–ï–ù–î ==========
          echo "üé® Building frontend..."
          cd /home/django/may-walk-map/frontend
          
          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ Node.js –µ—Å–ª–∏ –Ω—É–∂–Ω–æ
          if ! command -v node &> /dev/null; then
            echo "üì¶ Installing Node.js..."
            curl -fsSL https://deb.nodesource.com/setup_18.x | sudo -E bash -
            sudo apt-get install -y nodejs
          fi
          
          echo "Node: $(node --version)"
          echo "npm: $(npm --version)"
          
          # –£—Å—Ç–∞–Ω–æ–≤–∫–∞ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–µ–π —Å —Ñ–ª–∞–≥–æ–º –¥–ª—è –æ–±—Ö–æ–¥–∞ –∫–æ–Ω—Ñ–ª–∏–∫—Ç–æ–≤
          echo "üì¶ Installing dependencies..."
          npm install --legacy-peer-deps --no-audit
          
          # –°–±–æ—Ä–∫–∞ —Å —É–≤–µ–ª–∏—á–µ–Ω–∏–µ–º –ø–∞–º—è—Ç–∏
          echo "üèóÔ∏è Building React app..."
          NODE_OPTIONS="--max-old-space-size=1024" npm run build
          
          # –ü—Ä–æ–≤–µ—Ä–∫–∞ —á—Ç–æ —Å–±–æ—Ä–∫–∞ —É—Å–ø–µ—à–Ω–∞
          if [ -f "dist/index.html" ]; then
            echo "‚úÖ Frontend built successfully!"
            echo "Dist size: $(du -sh dist)"
          else
            echo "‚ùå Frontend build failed!"
            echo "Trying alternative build..."
            npx vite build || echo "Build failed, continuing with old version"
          fi
          
          # ========== 4. NGINX ==========
          echo "üåê Restarting web server..."
          sudo nginx -t
          sudo systemctl restart nginx
          
          # ========== 5. –ü–†–û–í–ï–†–ö–ê ==========
          echo "‚úÖ Deployment completed!"
          echo "========================================"
          echo "üåç Site: http://80.87.102.247/"
          echo "üìä API: http://80.87.102.247/map/api/routes/"
          echo "‚öôÔ∏è Admin: http://80.87.102.247/admin/"
          echo "========================================"